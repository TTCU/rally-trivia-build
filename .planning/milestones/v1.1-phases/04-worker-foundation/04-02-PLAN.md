---
phase: 04-worker-foundation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .dev.vars
autonomous: false
requirements: [FORM-04]

must_haves:
  truths:
    - "Resend API key is stored as a Cloudflare Workers secret (not in source code or git history)"
    - "Local development has a .dev.vars file with RESEND_API_KEY placeholder"
    - "Resend sending domain (rallytrivia.com) has verified DNS records"
  artifacts:
    - path: ".dev.vars"
      provides: "Local development secrets"
      contains: "RESEND_API_KEY"
  key_links:
    - from: ".dev.vars"
      to: "src/worker/index.ts"
      via: "env.RESEND_API_KEY binding"
      pattern: "RESEND_API_KEY"
---

<objective>
Store the Resend API key as a Cloudflare Workers secret and verify the Resend sending domain DNS records. This ensures the Worker can send email in Phase 5 without any secrets in source code.

Purpose: Secure secret management and verified email domain are prerequisites for the Phase 5 form backend.
Output: Wrangler secret set, .dev.vars created, Resend DNS verified.
</objective>

<execution_context>
@/Users/jslitzker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jslitzker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-worker-foundation/04-RESEARCH.md
@.planning/phases/04-worker-foundation/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create local development secrets file</name>
  <files>
    .dev.vars
  </files>
  <action>
1. **Create `.dev.vars`** in project root with placeholder content:
   ```
   # Local development secrets — DO NOT commit (covered by .gitignore)
   # Replace with your actual Resend API key from https://resend.com/api-keys
   RESEND_API_KEY=re_YOUR_KEY_HERE
   ```

2. **Verify `.gitignore` coverage** — confirm `.dev.vars*` pattern exists in `.gitignore` (already confirmed during research, but double-check).

3. **Verify `.dev.vars` is NOT tracked by git** — run `git status` and confirm `.dev.vars` does not appear in tracked or staged files.
  </action>
  <verify>
- `.dev.vars` file exists in project root
- `git status` does NOT show `.dev.vars` as a new or modified file
- `grep "dev.vars" .gitignore` returns a matching pattern
  </verify>
  <done>
.dev.vars exists with placeholder API key, is excluded from git tracking by .gitignore, and will never be committed.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Store Resend API key as Wrangler secret and verify DNS</name>
  <action>Two manual steps that Claude cannot perform (requires account credentials and API key values).</action>
  <instructions>
### Step 1: Store the Resend API Key as a Wrangler Secret

Run this command in the project root:

```bash
npx wrangler secret put RESEND_API_KEY
```

When prompted, paste your Resend API key (get it from https://resend.com/api-keys).

The key is stored encrypted on Cloudflare's servers — it never appears in source code or git history.

**Also update `.dev.vars`** — replace `re_YOUR_KEY_HERE` with your actual API key for local development.

### Step 2: Verify Resend Sending Domain DNS

1. Go to Resend dashboard → Domains (https://resend.com/domains)
2. If `rallytrivia.com` is NOT listed: click "Add Domain", enter `rallytrivia.com`, select your sending region
3. Resend will show DNS records to add. Go to Cloudflare DNS (https://dash.cloudflare.com → rallytrivia.com → DNS)
4. Add each record Resend shows. **CRITICAL:** Set ALL records to **DNS Only (grey cloud)** — not Proxied (orange cloud). This includes:
   - **MX record** on `send` subdomain (e.g., `send.rallytrivia.com`)
   - **TXT record** (SPF) on `send` subdomain
   - **TXT record** (DKIM) on `resend._domainkey` subdomain
   - **TXT record** (DMARC) on `_dmarc` subdomain (optional but in success criteria)
5. In Cloudflare DNS, enter only the subdomain portion (e.g., `send`, not `send.rallytrivia.com`)
6. Back in Resend dashboard, click "Verify DNS" — all records should show as verified
7. If DKIM stays "pending": confirm the record is set to grey cloud (DNS Only), not orange cloud (Proxied)

**From address will be:** `contact@rallytrivia.com`
  </instructions>
  <resume-signal>Type "done" when both the Wrangler secret is stored and Resend DNS is verified, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
1. `npx wrangler secret list` shows `RESEND_API_KEY` in the output
2. `.dev.vars` exists and is gitignored
3. Resend dashboard shows `rallytrivia.com` domain as verified (green checkmarks)
4. No secrets appear in any source file or git history
</verification>

<success_criteria>
- Resend API key stored as Wrangler secret (production) and in .dev.vars (local dev)
- Resend sending domain verified with passing DNS records (DKIM, SPF, DMARC)
- No secrets in source code or git history
</success_criteria>

<output>
After completion, create `.planning/phases/04-worker-foundation/04-02-SUMMARY.md`
</output>
