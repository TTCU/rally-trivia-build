---
phase: 04-worker-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wrangler.jsonc
  - src/worker/index.ts
  - src/worker/tsconfig.json
  - package.json
  - scripts/test-worker.sh
autonomous: true
requirements: [FORM-02]

must_haves:
  truths:
    - "POST /api/contact returns JSON { ok: true } from the Worker stub"
    - "Static pages (/, /features, /about, /contact) continue to serve correctly"
    - "npm run dev starts both Astro and Worker dev servers"
    - "npm test runs a verification script against the Worker stub"
  artifacts:
    - path: "wrangler.jsonc"
      provides: "Worker + static assets routing config"
      contains: "run_worker_first"
    - path: "src/worker/index.ts"
      provides: "Worker fetch handler stub"
      contains: "Response.json"
    - path: "src/worker/tsconfig.json"
      provides: "Worker-specific TypeScript config"
      contains: "worker-configuration"
    - path: "scripts/test-worker.sh"
      provides: "Stub endpoint verification script"
      contains: "api/contact"
  key_links:
    - from: "wrangler.jsonc"
      to: "src/worker/index.ts"
      via: "main entrypoint"
      pattern: '"main".*src/worker/index.ts'
    - from: "wrangler.jsonc"
      to: "dist/"
      via: "assets.directory"
      pattern: '"directory".*dist'
---

<objective>
Create the Cloudflare Worker infrastructure: restructure wrangler.jsonc for Worker + static assets coexistence, implement the stub endpoint at `src/worker/index.ts`, set up Worker-specific TypeScript config, update npm scripts for combined dev workflow, and add an automated test script.

Purpose: Validate the Worker routing pattern before adding any email complexity in Phase 5.
Output: Working Worker stub that responds to POST /api/contact with `{ ok: true }`, combined dev command, and test script.
</objective>

<execution_context>
@/Users/jslitzker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jslitzker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-worker-foundation/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Worker stub and restructure wrangler config</name>
  <files>
    wrangler.jsonc
    src/worker/index.ts
    src/worker/tsconfig.json
  </files>
  <action>
1. **Restructure `wrangler.jsonc`** — replace current static-only config with Worker + assets config:
   ```jsonc
   {
     "name": "rally-trivia-build",
     "compatibility_date": "2025-10-08",
     "main": "./src/worker/index.ts",
     "assets": {
       "directory": "./dist",
       "binding": "ASSETS",
       "run_worker_first": ["/api/*"]
     }
   }
   ```
   Keep existing `compatibility_date` value (2025-10-08) — it post-dates the `run_worker_first` array feature (June 2025).

2. **Create `src/worker/index.ts`** — minimal Worker fetch handler:
   - POST `/api/contact` → `Response.json({ ok: true })` (200)
   - Non-POST `/api/contact` → `Response.json({ ok: false, message: "Method not allowed" }, { status: 405 })`
   - Any other `/api/*` → `Response.json({ ok: false, message: "Not found" }, { status: 404 })`
   - Fallthrough to `env.ASSETS.fetch(request)` as safety net
   - Use `satisfies ExportedHandler<Env>` pattern
   - Define `Env` interface with `ASSETS: Fetcher` and `RESEND_API_KEY: string`
   - Follow exact code pattern from 04-RESEARCH.md "Worker Stub" code example

3. **Run `npx wrangler types`** to generate `worker-configuration.d.ts` in the project root.

4. **Create `src/worker/tsconfig.json`** — extends root tsconfig, adds Worker types:
   ```json
   {
     "extends": "../../tsconfig.json",
     "compilerOptions": {
       "types": ["../../worker-configuration.d.ts"],
       "module": "ESNext",
       "moduleResolution": "bundler",
       "lib": ["ES2022"]
     },
     "include": ["./**/*.ts"]
   }
   ```
   Do NOT modify the root `tsconfig.json` — this avoids conflicts with Astro's type setup (see Pitfall 3 in research).

5. Verify `astro check` still passes (no type conflicts introduced).
  </action>
  <verify>
- `npx wrangler dev --port 8787` starts without errors
- `curl -s -X POST http://localhost:8787/api/contact` returns `{"ok":true}`
- `curl -s http://localhost:8787/api/contact` returns 405
- `curl -s http://localhost:8787/api/nonexistent` returns 404
- `npx astro build` completes without errors
  </verify>
  <done>
Worker stub responds correctly to POST /api/contact with { ok: true }, rejects non-POST with 405, returns 404 for unknown API routes, and Astro build still works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update dev scripts and add test automation</name>
  <files>
    package.json
    scripts/test-worker.sh
  </files>
  <action>
1. **Install concurrently** as a dev dependency:
   ```bash
   npm install --save-dev concurrently
   ```

2. **Update `package.json` scripts** — restructure for combined dev workflow:
   ```json
   {
     "scripts": {
       "astro": "astro",
       "build": "astro build",
       "cf-typegen": "wrangler types",
       "check": "astro build && tsc && wrangler deploy --dry-run",
       "deploy": "wrangler deploy",
       "dev": "concurrently \"astro dev\" \"wrangler dev --port 8787\"",
       "dev:astro": "astro dev",
       "dev:worker": "wrangler dev --port 8787",
       "preview": "astro build && wrangler dev",
       "test": "bash scripts/test-worker.sh"
     }
   }
   ```
   Key changes:
   - `dev` → uses `concurrently` to run Astro (port 4321) + Worker (port 8787) in parallel
   - Add `dev:astro` and `dev:worker` for running individually
   - Add `test` → runs the stub verification script

3. **Create `scripts/test-worker.sh`** — automated stub verification:
   ```bash
   #!/bin/bash
   # Test Worker stub endpoint
   # Requires: wrangler dev running on port 8787

   RESPONSE=$(curl -s -X POST http://localhost:8787/api/contact \
     -H "Content-Type: application/json" \
     -d '{}')
   echo "Response: $RESPONSE"
   if echo "$RESPONSE" | grep -q '"ok":true'; then
     echo "PASS: POST /api/contact returns { ok: true }"
   else
     echo "FAIL: unexpected response from POST /api/contact"
     exit 1
   fi

   # Test 405 for GET
   RESPONSE_GET=$(curl -s http://localhost:8787/api/contact)
   echo "GET Response: $RESPONSE_GET"
   if echo "$RESPONSE_GET" | grep -q '"Method not allowed"'; then
     echo "PASS: GET /api/contact returns 405"
   else
     echo "FAIL: GET /api/contact did not return 405"
     exit 1
   fi

   echo ""
   echo "All tests passed."
   ```
   Make the script executable: `chmod +x scripts/test-worker.sh`

4. Verify the full dev workflow works: `npm run dev` starts both servers.
  </action>
  <verify>
- `npm run dev` starts both Astro (port 4321) and Worker (port 8787) simultaneously
- `npm test` (with wrangler dev running) outputs "All tests passed."
- `npm run dev:astro` starts only Astro
- `npm run dev:worker` starts only the Worker
  </verify>
  <done>
Combined dev command starts both servers, test script verifies stub endpoint returns correct responses for POST (200) and GET (405), and individual dev commands work independently.
  </done>
</task>

</tasks>

<verification>
1. `npx astro build` succeeds (static pages unbroken)
2. `npx wrangler dev --port 8787` starts the Worker
3. POST /api/contact returns `{ ok: true }` (200)
4. GET /api/contact returns `{ ok: false, message: "Method not allowed" }` (405)
5. GET /api/nonexistent returns `{ ok: false, message: "Not found" }` (404)
6. `npm run dev` starts both Astro and Worker
7. `npm test` passes (with Worker running)
8. No TypeScript errors in Worker code (`tsc --project src/worker/tsconfig.json`)
</verification>

<success_criteria>
- Worker stub is deployed-ready and responds correctly to API routes
- Static page serving is unaffected by wrangler.jsonc changes
- Combined dev workflow runs with a single command
- Automated test script validates the stub endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/04-worker-foundation/04-01-SUMMARY.md`
</output>
