---
phase: 04-worker-foundation
plan: 01
subsystem: infra
tags: [cloudflare-workers, wrangler, typescript, concurrently]

# Dependency graph
requires:
  - phase: 03-contact-form
    provides: Contact form UI that will POST to /api/contact
provides:
  - Cloudflare Worker stub at src/worker/index.ts handling /api/* routes
  - wrangler.jsonc restructured for Worker + static assets coexistence
  - Combined dev workflow (astro dev + wrangler dev via concurrently)
  - Automated test script verifying stub endpoint responses
affects:
  - 04-02 (next plans in worker-foundation phase)
  - 05-email-delivery (Worker email implementation builds on this stub)

# Tech tracking
tech-stack:
  added: [concurrently ^9.2.1]
  patterns:
    - "Worker + static assets via run_worker_first: [\"/api/*\"] in wrangler.jsonc"
    - "Separate src/worker/tsconfig.json extending root to avoid Astro type conflicts"
    - "Response.json() for API responses with typed Env interface"
    - "wrangler types for auto-generated worker-configuration.d.ts"

key-files:
  created:
    - src/worker/index.ts
    - src/worker/tsconfig.json
    - worker-configuration.d.ts
    - scripts/test-worker.sh
  modified:
    - wrangler.jsonc
    - package.json
    - package-lock.json

key-decisions:
  - "Use run_worker_first array form [\"/api/*\"] not boolean true — avoids Worker invocation for static pages"
  - "Create src/worker/tsconfig.json extending root instead of modifying root tsconfig — prevents Astro type conflicts"
  - "wrangler types (generated) over @cloudflare/workers-types npm package — stays in sync with actual bindings"
  - "concurrently over npm-run-all for parallel dev — named process output and kills-others-on-fail behavior"
  - "No CORS headers added — same origin in production; defer if needed in Phase 5"

patterns-established:
  - "Pattern 1: Worker fetch handler checks url.pathname + request.method, falls through to env.ASSETS.fetch() as safety net"
  - "Pattern 2: API response shape { ok: true/false, message?: string } with RESTful status codes"
  - "Pattern 3: Worker TypeScript config isolated in src/worker/tsconfig.json to prevent root tsconfig pollution"

requirements-completed: [FORM-02]

# Metrics
duration: 2min
completed: 2026-02-22
---

# Phase 4 Plan 01: Worker Foundation Summary

**Cloudflare Worker stub with TypeScript, run_worker_first routing, combined astro+wrangler dev command, and automated curl-based endpoint verification script**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-22T23:13:51Z
- **Completed:** 2026-02-22T23:15:46Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Worker stub at `src/worker/index.ts` returns `{ ok: true }` for POST /api/contact, 405 for non-POST, 404 for unknown `/api/*` routes
- `wrangler.jsonc` restructured with `main`, `assets.binding`, and `run_worker_first: ["/api/*"]` for correct static + Worker coexistence
- Combined `npm run dev` launches both Astro (port 4321) and Worker (port 8787) via `concurrently`
- `npm test` runs `scripts/test-worker.sh` which validates POST 200 and GET 405 responses
- `wrangler types` generated `worker-configuration.d.ts`; Worker-specific `tsconfig.json` created without touching root config

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Worker stub and restructure wrangler config** - `9f98de4` (feat)
2. **Task 2: Update dev scripts and add test automation** - `2f40d65` (feat)

**Plan metadata:** `8e8eb43` (docs: complete plan)

## Files Created/Modified
- `wrangler.jsonc` - Restructured with main entrypoint, ASSETS binding, run_worker_first array
- `src/worker/index.ts` - Cloudflare Worker fetch handler stub with method/path routing
- `src/worker/tsconfig.json` - Worker-specific TypeScript config extending root, adds Worker types
- `worker-configuration.d.ts` - Auto-generated by wrangler types; typed Env interface matching wrangler.jsonc bindings
- `scripts/test-worker.sh` - Shell test script verifying POST 200 and GET 405 responses
- `package.json` - Updated dev script to use concurrently; added dev:astro, dev:worker, test scripts
- `package-lock.json` - Updated with concurrently dependency

## Decisions Made
- Used `run_worker_first: ["/api/*"]` (array, not boolean) to ensure Worker is only invoked for API routes, not static pages
- Created `src/worker/tsconfig.json` separate from root tsconfig to prevent conflicts with Astro's strict type setup (Pitfall 3 from research)
- Used `wrangler types` to generate `worker-configuration.d.ts` rather than installing `@cloudflare/workers-types` — more accurate and stays in sync with actual bindings
- Used `concurrently` for parallel dev scripts for named process output and proper signal handling
- Deferred CORS headers — same origin in production makes them unnecessary; can revisit in Phase 5 if dev workflow requires it

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required. (Resend API key setup is deferred to Phase 5.)

## Next Phase Readiness
- Worker infrastructure is deploy-ready; validates routing pattern before adding email logic
- Phase 5 (email delivery) can now implement the actual Resend API call in place of the `{ ok: true }` stub
- `RESEND_API_KEY` secret needs to be stored via `wrangler secret put RESEND_API_KEY` before Phase 5 deployment
- `src/worker/index.ts` already has `RESEND_API_KEY: string` in the `Env` interface — Phase 5 can use it immediately

---
*Phase: 04-worker-foundation*
*Completed: 2026-02-22*
