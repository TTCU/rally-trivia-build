---
phase: 06-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Analytics.astro
  - src/components/EventTracking.astro
  - src/layouts/BaseLayout.astro
  - src/components/Nav.astro
  - src/pages/index.astro
  - src/pages/about.astro
  - src/pages/features.astro
  - scripts/test-analytics.sh
autonomous: false
requirements:
  - ANLX-01
  - ANLX-02
user_setup:
  - service: cloudflare-web-analytics
    why: "Beacon token required — only obtainable from CF dashboard"
    dashboard_config:
      - task: "Create Web Analytics site for rallytrivia.com"
        location: "Cloudflare Dashboard -> Web Analytics -> Add a site -> enter rallytrivia.com -> copy the 32-character hex token"

must_haves:
  truths:
    - "Every rendered page contains the CF Web Analytics beacon script tag in its HTML"
    - "Pageview data appears in the Cloudflare Web Analytics dashboard after a site visit"
    - "Referrer data appears in the dashboard for navigations with a referrer header"
    - "All 9 CTA links have data-track-event attributes for future event tracking readiness"
  artifacts:
    - path: "src/components/Analytics.astro"
      provides: "CF Web Analytics beacon script tag with hardcoded token"
      min_lines: 8
    - path: "src/components/EventTracking.astro"
      provides: "Client-side event hook wiring for data-track-event elements"
      min_lines: 15
    - path: "scripts/test-analytics.sh"
      provides: "Build-output verification that beacon exists in all 4 pages"
      min_lines: 20
  key_links:
    - from: "src/components/Analytics.astro"
      to: "src/layouts/BaseLayout.astro"
      via: "import and render in <head>"
      pattern: "import Analytics from.*Analytics.astro"
    - from: "src/components/EventTracking.astro"
      to: "src/layouts/BaseLayout.astro"
      via: "import and render before </body>"
      pattern: "import EventTracking from.*EventTracking.astro"
    - from: "src/layouts/BaseLayout.astro"
      to: "all 4 pages"
      via: "BaseLayout is the root layout for every page"
      pattern: "<Analytics />"
---

<objective>
Add Cloudflare Web Analytics beacon to every page and wire CTA event tracking hooks for future readiness.

Purpose: Enable traffic, referrer, and conversion path visibility from day one. All 4 pages get the beacon automatically via BaseLayout. CTA links get data-track-event attributes for future event destination integration (CF Web Analytics does not support custom events — hooks are future-ready for Zaraz or custom endpoint).

Output: Analytics.astro component, EventTracking.astro component, updated BaseLayout, CTA markup with data attributes, verification test script.
</objective>

<execution_context>
@/Users/jslitzker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jslitzker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-analytics/06-RESEARCH.md
@src/layouts/BaseLayout.astro
@src/components/Nav.astro
@src/pages/index.astro
@src/pages/about.astro
@src/pages/features.astro
@src/pages/contact.astro
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create CF Web Analytics site and obtain beacon token</name>
  <action>
    The user must create a Web Analytics site in the Cloudflare dashboard to obtain the beacon token.
    Claude cannot access the CF dashboard — this is a true human-only action.
  </action>
  <how-to-do-it>
    1. Go to Cloudflare Dashboard → Web Analytics (left sidebar)
    2. Click "Add a site"
    3. Enter hostname: rallytrivia.com
    4. Copy the 32-character hex token from the generated JS snippet
    5. Share the token with Claude (it is NOT secret — CF Web Analytics tokens are public identifiers that only route pageview data to your account)
  </how-to-do-it>
  <resume-signal>Paste the 32-character hex token (e.g., "abc123def456...")</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create Analytics beacon component and EventTracking hooks, integrate into BaseLayout, add CTA data attributes, create verification test</name>
  <files>
    src/components/Analytics.astro
    src/components/EventTracking.astro
    src/layouts/BaseLayout.astro
    src/components/Nav.astro
    src/pages/index.astro
    src/pages/about.astro
    src/pages/features.astro
    scripts/test-analytics.sh
  </files>
  <action>
    **1. Create `src/components/Analytics.astro`:**
    - Single-purpose component containing only the CF Web Analytics beacon script tag.
    - Hardcode the token provided by the user in Task 1 as a frontmatter const.
    - Use `defer` attribute and the exact CDN URL: `https://static.cloudflareinsights.com/beacon.min.js`
    - Use template literal for `data-cf-beacon` attribute to avoid Astro quoting issues: `data-cf-beacon={JSON.stringify({ token })}`
    - No props — token is hardcoded (public by nature, per user decision).
    - No dev/prod conditional — beacon loads on all environments including localhost (per user decision).

    **2. Create `src/components/EventTracking.astro`:**
    - Contains an inline `<script>` that runs on DOMContentLoaded.
    - Queries all elements with `[data-track-event]` attribute and attaches click listeners.
    - Each listener reads `data-track-event` (event name) and `data-track-label` (descriptive label).
    - Since CF Web Analytics does NOT support custom events (confirmed by official FAQ), the handler is a no-op for now. Add a code comment: "CF Web Analytics does not support custom events. Replace with zaraz.track(eventName, { label }) if Zaraz is enabled, or send to a custom endpoint."
    - This is future-ready wiring — the markup and hooks exist so enabling a destination later is a one-line change.

    **3. Update `src/layouts/BaseLayout.astro`:**
    - Import `Analytics` from `../components/Analytics.astro` in the frontmatter.
    - Import `EventTracking` from `../components/EventTracking.astro` in the frontmatter.
    - Render `<Analytics />` inside `<head>` after `<BaseHead ... />`.
    - Render `<EventTracking />` inside `<body>` before `</body>` (after `<ScrollAnimations />`).
    - Do NOT modify any existing imports or elements.

    **4. Add `data-track-event` and `data-track-label` attributes to all 9 CTA links:**

    In `src/components/Nav.astro`:
    - Desktop "Request a Demo" link: add `data-track-event="cta_click"` `data-track-label="nav_desktop_request_demo"`
    - Mobile "Request a Demo" link: add `data-track-event="cta_click"` `data-track-label="nav_mobile_request_demo"`

    In `src/pages/index.astro`:
    - Hero "Request a Demo" link: `data-track-event="cta_click"` `data-track-label="hero_request_demo"`
    - Nonprofit card "Get Started" link: `data-track-event="cta_click"` `data-track-label="nonprofit_get_started"`
    - Corporate card "Get Started" link: `data-track-event="cta_click"` `data-track-label="corporate_get_started"`
    - Footer CTA "Request a Demo" link: `data-track-event="cta_click"` `data-track-label="footer_cta_request_demo"`

    In `src/pages/about.astro`:
    - Bottom "Request a Demo" link: `data-track-event="cta_click"` `data-track-label="about_bottom_request_demo"`

    In `src/pages/features.astro`:
    - Mid-page "Request a Demo" link: `data-track-event="cta_click"` `data-track-label="features_mid_request_demo"`
    - Bottom "Request a Demo" link: `data-track-event="cta_click"` `data-track-label="features_bottom_request_demo"`

    To identify the correct elements, search for `href="/contact"` in each file and add the data attributes to the `<a>` tag.

    **5. Create `scripts/test-analytics.sh`:**
    - Follow the existing bash test pattern from `scripts/test-worker.sh`.
    - Run `npm run build` first.
    - Check all 4 built HTML files in `dist/`: `index.html`, `about/index.html`, `features/index.html`, `contact/index.html`.
    - For each file, verify that `static.cloudflareinsights.com/beacon.min.js` appears in the HTML.
    - Also verify the beacon token string appears in each file.
    - Print PASS/FAIL for each page, exit 1 if any fail.
    - Make the script executable (`chmod +x`).

    **IMPORTANT NOTES:**
    - Do NOT add any `window.__cfBeacon.track()` calls — this API does not exist.
    - Do NOT use env variables for the token — it's intentionally public (per user decision).
    - Do NOT add cookie consent banners — CF Web Analytics is cookieless (per user decision).
    - contact.astro does NOT need CTA data attributes — it IS the conversion destination.
  </action>
  <verify>
    1. Run `npm run build` — build succeeds with no errors.
    2. Run `bash scripts/test-analytics.sh` — all 4 pages show PASS.
    3. Grep dist/index.html for `beacon.min.js` — present.
    4. Grep dist/contact/index.html for `beacon.min.js` — present.
    5. Grep dist/index.html for `data-track-event` — present (confirms CTA attributes rendered).
  </verify>
  <done>
    - Analytics.astro component exists with hardcoded CF beacon token
    - EventTracking.astro component exists with DOMContentLoaded click handler for data-track-event elements
    - BaseLayout.astro imports and renders both Analytics (in head) and EventTracking (before body close)
    - All 9 CTA links across Nav, index, about, and features have data-track-event and data-track-label attributes
    - test-analytics.sh passes against built HTML output confirming beacon presence on all 4 pages
    - No cookie banners, no env vars for token, no custom event API calls
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify analytics beacon in production and dashboard data</name>
  <action>
    Human verifies that the CF Web Analytics beacon loads on all pages and that pageview data appears in the Cloudflare dashboard after deployment.
  </action>
  <what-built>CF Web Analytics beacon integrated on all pages with CTA event tracking hooks. Beacon loads on every page including localhost.</what-built>
  <how-to-verify>
    1. Run `npm run dev` and open http://localhost:4321 in browser
    2. Open browser DevTools → Network tab → filter for "beacon" — confirm beacon.min.js loads
    3. View page source (Ctrl/Cmd+U) — confirm `data-cf-beacon` attribute with token is present
    4. Navigate to /features, /about, /contact — confirm beacon loads on each page
    5. Right-click a "Request a Demo" button → Inspect → confirm `data-track-event="cta_click"` attribute present
    6. Deploy to production: `wrangler deploy`
    7. Visit rallytrivia.com in a browser
    8. Wait 2-5 minutes, then check Cloudflare Dashboard → Web Analytics → rallytrivia.com
    9. Confirm at least one pageview appears in the dashboard (satisfies ANLX-02)
  </how-to-verify>
  <verify>User confirms pageview data is visible in CF Web Analytics dashboard</verify>
  <done>ANLX-02 satisfied — pageviews and referrer data visible in Cloudflare dashboard</done>
  <resume-signal>Type "approved" if pageview data appears in CF dashboard, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `bash scripts/test-analytics.sh` — all 4 pages PASS (beacon present in rendered HTML)
3. Beacon script loads on localhost (DevTools Network tab)
4. After deployment, pageview data visible in CF Web Analytics dashboard within minutes
5. CTA links have `data-track-event` attributes in rendered HTML
</verification>

<success_criteria>
- ANLX-01: All 4 pages include the CF Web Analytics beacon script (verified by automated test against build output)
- ANLX-02: Pageviews and referrer data visible in CF dashboard after production deployment and a real site visit
- Future-ready CTA event hooks: All 9 CTA links have data-track-event attributes with descriptive labels; EventTracking component wires click handlers ready for a future event destination (Zaraz or custom endpoint)
</success_criteria>

<output>
After completion, create `.planning/phases/06-analytics/06-01-SUMMARY.md`
</output>
