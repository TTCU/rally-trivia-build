---
phase: 05-form-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/worker/index.ts
  - src/components/ContactForm.astro
  - package.json
  - package-lock.json
  - .env.example
  - .dev.vars
  - scripts/test-worker.sh
autonomous: true
requirements: [FORM-01, FORM-03]

user_setup:
  - service: cloudflare-turnstile
    why: "Spam protection — Turnstile widget requires a site key (public) and secret key (private)"
    env_vars:
      - name: TURNSTILE_SECRET_KEY
        source: "Cloudflare Dashboard -> Turnstile -> your site -> Settings -> Secret Key"
      - name: PUBLIC_TURNSTILE_SITE_KEY
        source: "Cloudflare Dashboard -> Turnstile -> your site -> Settings -> Site Key"
    dashboard_config:
      - task: "Create a Turnstile widget for rallytrivia.com"
        location: "Cloudflare Dashboard -> Turnstile -> Add Widget"
  - service: wrangler-secrets
    why: "Production secrets for Turnstile verification and email recipient"
    env_vars:
      - name: TURNSTILE_SECRET_KEY
        source: "npx wrangler secret put TURNSTILE_SECRET_KEY"
      - name: RECIPIENT_EMAIL
        source: "npx wrangler secret put RECIPIENT_EMAIL"

must_haves:
  truths:
    - "Submitting the contact form causes an email to arrive in the recipient inbox"
    - "The form shows a spinning loader while the request is in flight"
    - "The thank-you animation only plays after a confirmed 2xx response from the Worker"
    - "If the Worker returns an error, the form displays an error message without clearing the user's input"
    - "A 'Try Again' button appears on error and re-submits the preserved form data"
    - "Turnstile blocks bot submissions before the Worker sends any email"
  artifacts:
    - path: "src/worker/index.ts"
      provides: "Real email sending via Resend SDK + Turnstile server-side verification"
      contains: "resend.emails.send"
    - path: "src/components/ContactForm.astro"
      provides: "Real fetch to /api/contact with error handling, retry, and Turnstile widget"
      contains: "fetch.*api/contact"
    - path: ".env.example"
      provides: "Public Turnstile site key placeholder"
      contains: "PUBLIC_TURNSTILE_SITE_KEY"
  key_links:
    - from: "src/components/ContactForm.astro"
      to: "/api/contact"
      via: "fetch POST with JSON body including turnstileToken"
      pattern: "fetch.*api/contact.*POST"
    - from: "src/worker/index.ts"
      to: "challenges.cloudflare.com/turnstile/v0/siteverify"
      via: "Server-side Turnstile token verification before sending email"
      pattern: "turnstile.*siteverify"
    - from: "src/worker/index.ts"
      to: "resend.emails.send"
      via: "Resend SDK call with HTML body and env.RECIPIENT_EMAIL"
      pattern: "resend\\.emails\\.send"
---

<objective>
Wire the contact form to actually send emails through the Cloudflare Worker via Resend SDK, add Cloudflare Turnstile spam protection, and replace the current simulated submit delay with real API response handling (success, error, retry).

Purpose: Complete the form-to-email pipeline so demo requests from prospects actually reach the configured recipient inbox, with spam protection and proper user feedback.

Output: Working end-to-end contact form submission: form -> Turnstile verification -> Worker -> Resend email delivery, with loading/success/error UI states.
</objective>

<execution_context>
@/Users/jslitzker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jslitzker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-form-backend/05-CONTEXT.md
@.planning/phases/05-form-backend/05-RESEARCH.md
@.planning/phases/04-worker-foundation/04-01-SUMMARY.md
@src/worker/index.ts
@src/components/ContactForm.astro
@wrangler.jsonc
@scripts/test-worker.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Worker email sending with Turnstile verification</name>
  <files>
    src/worker/index.ts
    package.json
    package-lock.json
    .dev.vars
    .env.example
    scripts/test-worker.sh
  </files>
  <action>
    **Install Resend SDK:**
    ```bash
    npm install resend
    ```

    **Update `src/worker/index.ts`** — replace the Phase 4 stub with the real implementation:

    1. Add `import { Resend } from 'resend';` at the top.

    2. Update the `Env` interface to add new bindings:
       ```typescript
       interface Env {
         ASSETS: Fetcher;
         RESEND_API_KEY: string;       // Already declared from Phase 4
         TURNSTILE_SECRET_KEY: string; // New: Wrangler secret
         RECIPIENT_EMAIL: string;      // New: Wrangler secret
       }
       ```

    3. Add a `ContactPayload` interface:
       ```typescript
       interface ContactPayload {
         Name: string;
         Email: string;
         Organization?: string;
         'Event Type'?: string;
         Message?: string;
         turnstileToken: string;
       }
       ```
       **CRITICAL:** Field names must match the form's `name` attributes exactly: `Name`, `Email`, `Organization`, `Event Type`, `Message` (capitalized, with space in "Event Type"). The `turnstileToken` field is added by the client-side JS.

    4. Add a `buildEmailHtml(payload: ContactPayload): string` function that returns styled HTML:
       - Use brand navy color (#1e3a5f) for the header
       - Table layout with Name, Email, Organization, Event Type, Message rows
       - Use `payload['Event Type']` for the event type field (bracket notation due to space in key)
       - Show "—" dash for empty optional fields
       - Claude's discretion on exact email template styling — keep it clean and professional

    5. Add a `verifyTurnstile(token: string, secretKey: string): Promise<boolean>` function:
       - POST to `https://challenges.cloudflare.com/turnstile/v0/siteverify` with FormData containing `secret` and `response`
       - Parse JSON response, return `outcome.success`

    6. Replace the stub POST handler with:
       - Add CORS headers for `http://localhost:4321` (needed for local dev where Astro and Worker run on different ports):
         ```typescript
         const corsHeaders: Record<string, string> = {
           'Access-Control-Allow-Origin': 'http://localhost:4321',
           'Access-Control-Allow-Methods': 'POST, OPTIONS',
           'Access-Control-Allow-Headers': 'Content-Type',
         };
         ```
       - Handle OPTIONS preflight for `/api/contact` returning 204 with CORS headers
       - In POST handler: parse JSON body, verify Turnstile token (return 400 with `{ ok: false, message: 'Verification failed. Please try again.' }` if invalid), then send email via Resend SDK
       - Resend call: `from: 'Rally Trivia <contact@rallytrivia.com>'`, `to: [env.RECIPIENT_EMAIL]`, `subject: 'Demo Request from ${payload.Name}'`, `html: buildEmailHtml(payload)`
       - Check `{ data, error }` return from Resend — if error, return 500 with `{ ok: false, message: 'Something went wrong. Please try again.' }`
       - On success return `{ ok: true }` with CORS headers
       - Wrap entire handler in try/catch returning 500 with generic error message on unexpected errors
       - Include CORS headers on ALL responses from the POST handler (success, Turnstile failure, Resend failure, catch)

    **Create `.env.example`** (committed — `.gitignore` has `!.env.example`):
    ```
    # Cloudflare Turnstile site key (public — safe to commit)
    # Get from: Cloudflare Dashboard -> Turnstile -> your site -> Site Key
    # Use test key for local dev: 1x00000000000000000000AA
    PUBLIC_TURNSTILE_SITE_KEY=1x00000000000000000000AA
    ```

    **Update `.dev.vars`** — add new entries (file is gitignored):
    ```
    TURNSTILE_SECRET_KEY=1x0000000000000000000000000000000AA
    RECIPIENT_EMAIL=contact@rallytrivia.com
    ```
    The TURNSTILE_SECRET_KEY test value `1x0000000000000000000000000000000AA` always passes in Cloudflare's test mode. The RESEND_API_KEY line already exists — do not modify it.

    **Also create `.env`** from `.env.example` for local development (`.env` is gitignored):
    Copy the same content as `.env.example` so Astro can read `PUBLIC_TURNSTILE_SITE_KEY` at build time.

    **Update `scripts/test-worker.sh`** — the old test sends `{}` and expects `{ ok: true }`. Now the Worker requires a Turnstile token. Update:
    - Change POST test to send a complete payload with test turnstile token: `{ "Name": "Test User", "Email": "test@example.com", "turnstileToken": "test-token" }`
    - With the test secret key in `.dev.vars` (`1x0000000000000000000000000000000AA`), the Turnstile always-passes key will validate any token
    - Keep the GET 405 test as-is
    - Add a test for missing Turnstile token: send `{ "Name": "Test", "Email": "test@example.com" }` without turnstileToken, expect the response to contain `ok":false` (Turnstile verification fails for empty/missing token)
  </action>
  <verify>
    1. `npm run build` completes without TypeScript errors
    2. Start worker with `npx wrangler dev` and run `scripts/test-worker.sh` — all tests pass
    3. `.env.example` exists and contains `PUBLIC_TURNSTILE_SITE_KEY`
    4. `.env.example` does NOT contain any secret keys (no RESEND_API_KEY, no TURNSTILE_SECRET_KEY)
    5. `grep -r "RESEND_API_KEY" .env.example` returns nothing
  </verify>
  <done>
    Worker accepts POST /api/contact with form fields and Turnstile token, verifies the token server-side, sends email via Resend SDK to env.RECIPIENT_EMAIL, and returns appropriate JSON responses. Test script validates the happy path and missing-token rejection. .env.example committed with public site key placeholder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Connect ContactForm to real API with error handling and Turnstile widget</name>
  <files>
    src/components/ContactForm.astro
  </files>
  <action>
    **Update `src/components/ContactForm.astro`** to replace the simulated submit with a real API call, add Turnstile widget, and implement error/retry UX.

    **1. Add Turnstile site key in frontmatter:**
    ```astro
    ---
    const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
    ---
    ```

    **2. Add Turnstile script tag** — place BEFORE the closing `</div>` of the component's root div, or in a `<script is:inline>` tag:
    ```html
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer is:inline></script>
    ```
    Use `is:inline` so Astro does not try to process this third-party CDN script.

    **3. Add Turnstile widget div** in the form, just above the submit button (before the `<!-- Submit Button -->` comment):
    ```html
    <div class="cf-turnstile mb-6" data-sitekey={turnstileSiteKey} data-theme="light"></div>
    ```

    **4. Update the thank-you view text** per locked decisions:
    - Change `"We'll reach out within 24 hours."` to `"We'll be in touch soon."`
    - Remove any re-submit option — keep only the "Back to Home" link (already the case)

    **5. Replace the submit handler** (the `form.addEventListener('submit', ...)` block) with real API logic:

    - After validation passes and loading state is shown, collect form data using `new FormData(form)`:
      ```typescript
      const formData = new FormData(form);
      ```

    - **CRITICAL field name mapping:** The form fields use `name="Name"`, `name="Email"`, `name="Organization"`, `name="Event Type"`, `name="Message"`. Read them with `formData.get('Name')`, `formData.get('Email')`, `formData.get('Organization')`, `formData.get('Event Type')`, `formData.get('Message')`. The Turnstile hidden input is `formData.get('cf-turnstile-response')`.

    - Check that `cf-turnstile-response` is non-empty before submitting. If empty, show error "Please wait a moment and try again." and reset loading state. This handles the case where Turnstile hasn't finished yet (Pitfall 4 from research).

    - Use `Promise.all` with minimum loading time:
      ```typescript
      const MIN_LOADING_MS = 900;
      const [response] = await Promise.all([
        fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            Name: formData.get('Name'),
            Email: formData.get('Email'),
            Organization: formData.get('Organization'),
            'Event Type': formData.get('Event Type'),
            Message: formData.get('Message'),
            turnstileToken: formData.get('cf-turnstile-response'),
          }),
        }),
        new Promise<void>((resolve) => setTimeout(resolve, MIN_LOADING_MS)),
      ]);
      ```

    - Parse response:
      ```typescript
      let result: { ok: boolean; message?: string };
      try {
        result = await response.json();
      } catch {
        result = { ok: false, message: 'Something went wrong. Please try again.' };
      }
      ```

    - **Error branch** (if `!response.ok || !result.ok`):
      - Reset loading state: re-enable button, show btn-text, hide btn-spinner
      - Show error in the existing error summary banner: set `errorList.innerHTML` to a `<li>` with the error message (use `result.message` or fallback to "Something went wrong. Please try again.")
      - Show error summary, scroll it into view
      - **Reset Turnstile widget** so user gets a fresh token:
        ```typescript
        if ((window as any).turnstile) {
          (window as any).turnstile.reset();
        }
        ```
      - Do NOT clear form inputs (user input preserved per locked decision)
      - `return` to stop execution

    - **Success branch** (confirmed 2xx + `result.ok`):
      - Proceed with existing thank-you animation code (dynamic import of motion, fade out form wrapper, hide form, show thank-you, scroll to top, fade in thank-you)

    **6. Add TypeScript window.turnstile type** at the top of the `<script>` block:
    ```typescript
    declare global {
      interface Window {
        turnstile?: {
          reset: () => void;
          render: (container: string | Element, options: object) => string;
        };
      }
    }
    ```

    **Important implementation notes:**
    - The error summary banner (`#error-summary`) and error list (`#error-list`) already exist in the component HTML. Reuse them for API errors — same pattern as validation errors.
    - The "Try Again" retry button is NOT a separate button element. Per CONTEXT.md, the error banner with the message "Something went wrong. Please try again." IS the retry mechanism — the user simply clicks the existing "Request a Demo" submit button again (which is re-enabled in the error branch). The form inputs are preserved, Turnstile is reset, so clicking submit again retries with a fresh token.
    - Do NOT add a separate "Try Again" button — the existing submit button serves this purpose since form state is preserved.
  </action>
  <verify>
    1. `npm run build` completes without errors
    2. Open the built HTML (`dist/contact/index.html`) and verify:
       - Turnstile script tag is present
       - `cf-turnstile` div with `data-sitekey` attribute is present in the form
       - Thank-you text says "We'll be in touch soon." (not "within 24 hours")
    3. The `<script>` block contains `fetch('/api/contact'` (real fetch, not simulated delay)
    4. The `<script>` block contains `turnstile.reset()` (Turnstile reset on error)
    5. No `setTimeout(resolve, 1500)` remains (the old simulated delay is replaced)
  </verify>
  <done>
    ContactForm sends real POST to /api/contact with all form fields plus Turnstile token. Loading spinner shows during request (minimum 900ms). On 2xx success, thank-you animation plays with updated "We'll be in touch soon" text. On error, error banner appears with message, form inputs are preserved, Turnstile is reset for retry, and submit button is re-enabled.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `npm run dev` starts both Astro and Wrangler without errors
3. With test Turnstile keys in `.dev.vars` and `.env`, submitting the form on `localhost:4321` sends a POST to the Worker on `localhost:8787` (verify in browser Network tab)
4. With a valid Resend API key in `.dev.vars`, submitting the form actually delivers an email to the configured RECIPIENT_EMAIL
5. Submitting with Turnstile verification disabled (using the always-fails test secret key `2x0000000000000000000000000000000AA`) shows "Verification failed" error
6. If the Worker returns an error, the form shows the error message and preserves all user input
7. After an error, clicking submit again works (Turnstile token was reset)
</verification>

<success_criteria>
- Contact form submissions deliver email to the configured recipient inbox via Resend
- Form shows loading spinner during API request with minimum 900ms display time
- Thank-you animation plays only after confirmed 2xx response
- Error responses show user-friendly message without clearing form inputs
- Turnstile widget protects against bot submissions
- Turnstile resets on error so retry works
- `.env.example` committed with public site key placeholder
- All existing static pages continue to serve correctly
</success_criteria>

<output>
After completion, create `.planning/phases/05-form-backend/05-01-SUMMARY.md`
</output>
